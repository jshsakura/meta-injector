#!/usr/bin/env python3
"""
Little King's Story Classic Controller GCT 생성기
GBAtemp에서 추출한 코드로 GCT 파일 생성
"""

from pathlib import Path

OUTPUT_DIR = Path(__file__).parent.parent / "core" / "CCPatches"
OUTPUT_DIR.mkdir(parents=True, exist_ok=True)

# Little King's Story Gecko 코드 (GBAtemp에서 추출)
# 출처: https://gbatemp.net/threads/new-classic-controller-hacks.659837/
# 제작자: Vague Rant, crediar

CODES = {
    # USA 버전
    "ROUE5G": """
04060E74 60000000
04078FA4 28000002
04079550 28000002
04079558 C0230178
04079580 28000002
04079588 C023017C
C242A1B4 00000029
7C0802A6 80BF0060
48000041 809F0000
7CA52378 90BF0000
80BF0064 4800002D
809F0004 7CA52378
90BF0004 80BF0068
48000019 809F0008
7CA52378 90BF0008
7C0803A6 4E800020
38C00000 70A40800
2C040000 41820008
60C68000 70A40001
2C040000 41820008
60C60008 70A44000
2C040000 41820008
60C60004 70A40002
2C040000 41820008
60C60001 70A48000
2C040000 41820008
60C60002 70A40010
2C040000 41820008
60C60800 70A40040
2C040000 41820008
60C60400 70A40008
2C040000 41820008
60C60004 70A40020
2C040000 41820008
60C64000 70A42000
2C040000 41820008
60C60001 70A40200
2C040000 41820008
60C60002 70A40080
2C040000 41820008
60C62000 70A40004
2C040000 41820008
60C60008 70A40400
2C040000 41820008
60C60010 70A41000
2C040000 41820008
60C60300 7CC53378
4E800020 00000000
""",
    # EUR 버전
    "ROEP5G": """
04060B3C 60000000
0407837C 28000002
04078928 28000002
04078930 C0230178
04078958 28000002
04078960 C023017C
C2428858 00000029
7C0802A6 80BF0060
48000041 809F0000
7CA52378 90BF0000
80BF0064 4800002D
809F0004 7CA52378
90BF0004 80BF0068
48000019 809F0008
7CA52378 90BF0008
7C0803A6 4E800020
38C00000 70A40800
2C040000 41820008
60C68000 70A40001
2C040000 41820008
60C60008 70A44000
2C040000 41820008
60C60004 70A40002
2C040000 41820008
60C60001 70A48000
2C040000 41820008
60C60002 70A40010
2C040000 41820008
60C60800 70A40040
2C040000 41820008
60C60400 70A40008
2C040000 41820008
60C60004 70A40020
2C040000 41820008
60C64000 70A42000
2C040000 41820008
60C60001 70A40200
2C040000 41820008
60C60002 70A40080
2C040000 41820008
60C62000 70A40004
2C040000 41820008
60C60008 70A40400
2C040000 41820008
60C60010 70A41000
2C040000 41820008
60C60300 7CC53378
4E800020 00000000
""",
    # JPN 버전
    "ROUJ5G": """
04060CB0 60000000
04078F98 28000002
04079544 28000002
0407954C C0230178
04079574 28000002
0407957C C023017C
C2429B74 00000029
7C0802A6 80BF0060
48000041 809F0000
7CA52378 90BF0000
80BF0064 4800002D
809F0004 7CA52378
90BF0004 80BF0068
48000019 809F0008
7CA52378 90BF0008
7C0803A6 4E800020
38C00000 70A40800
2C040000 41820008
60C68000 70A40001
2C040000 41820008
60C60008 70A44000
2C040000 41820008
60C60004 70A40002
2C040000 41820008
60C60001 70A48000
2C040000 41820008
60C60002 70A40010
2C040000 41820008
60C60800 70A40040
2C040000 41820008
60C60400 70A40008
2C040000 41820008
60C60004 70A40020
2C040000 41820008
60C64000 70A42000
2C040000 41820008
60C60001 70A40200
2C040000 41820008
60C60002 70A40080
2C040000 41820008
60C62000 70A40004
2C040000 41820008
60C60008 70A40400
2C040000 41820008
60C60010 70A41000
2C040000 41820008
60C60300 7CC53378
4E800020 00000000
"""
}


def txt_to_gct(game_id: str, code_text: str) -> bytes:
    """텍스트 Gecko 코드를 GCT 바이너리로 변환"""
    # GCT 헤더
    gct_data = bytearray.fromhex('00D0C0DE00D0C0DE')

    # 코드 파싱
    lines = code_text.strip().split('\n')
    for line in lines:
        line = line.strip()
        if not line:
            continue

        # 공백으로 분리된 8자리 hex 값들
        parts = line.split()
        for part in parts:
            part = part.strip()
            if len(part) == 8 and all(c in '0123456789ABCDEFabcdef' for c in part):
                gct_data.extend(bytes.fromhex(part))

    # GCT 푸터
    gct_data.extend(bytes.fromhex('F000000000000000'))

    return bytes(gct_data)


def main():
    print("=" * 50)
    print("Little King's Story CC Patch GCT Generator")
    print("=" * 50)

    for game_id, code_text in CODES.items():
        gct_data = txt_to_gct(game_id, code_text)

        # 파일 저장
        output_path = OUTPUT_DIR / f"{game_id}.gct"
        with open(output_path, 'wb') as f:
            f.write(gct_data)

        print(f"[OK] {output_path.name} - {len(gct_data)} bytes")

    print()
    print(f"GCT files saved to: {OUTPUT_DIR}")
    print()
    print("Game IDs:")
    print("  ROUE5G - USA")
    print("  ROEP5G - Europe")
    print("  ROUJ5G - Japan")


if __name__ == "__main__":
    main()
