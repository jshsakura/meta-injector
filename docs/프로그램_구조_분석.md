# TeconmoonWiiVCInjector 프로그램 구조 분석

## 목차
1. [전체 프로젝트 구조](#1-전체-프로젝트-구조)
2. [핵심 변환 로직과 워크플로우](#2-핵심-변환-로직과-워크플로우)
3. [주요 클래스와 모듈](#3-주요-클래스와-모듈)
4. [Wii VC 인젝션 프로세스 상세](#4-wii-vc-인젝션-프로세스-상세)
5. [파일 타입 처리 및 변환 파이프라인](#5-파일-타입-처리-및-변환-파이프라인)
6. [아키텍처 패턴](#6-아키텍처-패턴)
7. [구현 현황 요약](#7-구현-현황-요약)

---

## 1. 전체 프로젝트 구조

### 프로젝트 아키텍처 개요

**언어 마이그레이션:**
- C# (.NET/WinForms) → Python (PyQt5)로 완전히 재작성
- Windows 전용 → 크로스 플랫폼(Windows/Linux/macOS) 지원
- PyInstaller를 사용한 독립 실행 파일 빌드

**디렉터리 구조:**
```
TeconmoonWiiVCInjector/
├── src/wiivc_injector/          # 메인 애플리케이션 모듈 (Python)
├── resources/                    # 정적 리소스 (wiitdb.txt, icon.ico)
├── OLD/                         # 구 버전 C# 원본 소스 보관
├── build.py                     # PyInstaller 빌드 스크립트
├── run.py                       # 빠른 실행 스크립트
└── requirements.txt             # Python 종속성
```

**핵심 종속성:**
- PyQt5 5.15.9+ (GUI 프레임워크)
- Pillow 10.0.0+ (이미지 처리)
- requests 2.31.0+ (HTTP 통신)
- pyinstaller 5.13.0+ (패키징)

---

## 2. 핵심 변환 로직과 워크플로우

### Wii VC 인젝션 전체 워크플로우

```
1. 준비 단계 (PREPARATION PHASE)
   ├── Nintendo 서버에서 베이스 파일 다운로드 (JNUSTool)
   ├── Wii VC 베이스 패키지 추출 (Rhythm Heaven Fever)
   ├── 암호화 키 검증 (Common Key, Title Key, Ancast Key)
   └── 임시 디렉터리 구조 생성

2. 게임 처리 단계 (GAME PROCESSING PHASE)
   ├── 게임 ISO/WBFS 헤더 읽기 (Title ID, 게임명 추출)
   ├── 파일 포맷 처리: ISO, WBFS, NKIT, NASOS, GCM
   ├── Wii용: ISO 추출 → 패치 (필요시) → ISO 재구성
   ├── GC용: Nintendont 로더로 래핑 → ISO 빌드
   ├── 홈브류/DOL: 베이스 ISO 구조로 래핑
   └── NAND용: 채널 런처 생성

3. 에셋 처리 단계 (ASSET PROCESSING PHASE)
   ├── 이미지 변환: PNG → TGA (아이콘, 배너, DRC, 로고)
   ├── 이미지 리사이징 (Wii U 표준 사양에 맞춤)
   ├── 오디오 변환: WAV/MP3 → BTSND (부팅 사운드)
   └── 빌드 디렉터리로 에셋 복사

4. 메타데이터 생성 단계 (METADATA GENERATION PHASE)
   ├── app.xml 생성 (애플리케이션 메타데이터)
   ├── meta.xml 생성 (게임 메타데이터, 지역, 등급)
   ├── 소스 게임에서 TMD/TIK 추출
   └── 패치 적용 (C2W, LR patch, Wiimmfi)

5. NFS 변환 단계 (NFS CONVERSION PHASE)
   ├── 게임 ISO → NFS 포맷 변환 (nfs2iso2nfs 도구)
   ├── 암호화 적용
   └── 트리밍/압축 옵션 처리

6. 패키징 단계 (PACKAGING PHASE)
   ├── WUP 설치 가능 포맷으로 패킹 (NUSPacker)
   ├── Wii U Common Key로 암호화
   ├── 최종 출력 디렉터리 생성
   └── 설치 가능 패키지 생성
```

### 사용되는 외부 도구 (TOOLDIR.zip 내)

| 도구 | 용도 |
|------|------|
| `wit.exe` | Wii ISO 도구 (ISO 추출/재구성) |
| `nfs2iso2nfs.exe` | NFS 파일시스템 변환기 |
| `NUSPacker.exe` | WUP 패키지 생성기 |
| `JNUSTool.exe` | Nintendo Update 서버 다운로더 |
| `png2tgacmd.exe` / `tga2pngcmd.exe` | 이미지 변환기 |
| `sox.exe` | 오디오 변환기 |
| `wav2btsnd.exe` | 부팅 사운드 변환기 |
| `c2w_patcher.exe` | Cafe2Wii 패처 |
| `GetExtTypePatcher.exe` | 확장 타입 패처 |
| `wbfs_file.exe` | WBFS 변환기 |
| `ConvertToISO.exe` | NKIT 변환기 |

---

## 3. 주요 클래스와 모듈

### A. 핵심 애플리케이션 레이어

**`main.py`**
- 진입점, main_window 실행

**`main_window.py` - `WiiVCInjectorWindow` 클래스**
- 메인 GUI 컨트롤러 (600+ 라인)
- 모든 UI 탭 및 사용자 상호작용 관리
- 모든 서브시스템 간 조정
- 상태 관리 (플래그, 선택된 파일, 옵션)
- 탭 기반 네비게이션 (Source Files, Meta, Advanced, Build)

### B. 데이터 추출 레이어

**`game_info.py` - `GameInfoExtractor` 클래스**
- ISO/WBFS 헤더 읽기 (오프셋 0x00, 0x20, 0x200에서 바이너리 파싱)
- 파일 타입 감지: ISO, WBFS, NKIT, NASOS, GCM
- Game ID 추출 (0x00에서 6바이트)
- 내부 게임명 추출 (0x20에서, null-terminated)
- Game ID로부터 Title ID 생성
- 시스템 감지: Wii vs GameCube (Game ID 접두사 기반)

**`game_tdb.py` - `GameTdb` 클래스**
- wiitdb.txt (344KB 게임 데이터베이스) 래퍼
- 캐싱을 사용한 지연 로딩 싱글톤 패턴
- 지역 변종 조회 (EUR/USA/JAP)
- ID로부터 게임명 번역

### C. 에셋 처리 레이어

**`image_utils.py` - `ImageProcessor` 클래스**

표준 사이즈 상수:
- **Icon**: 128x128 (1:1)
- **Banner**: 1280x720 (16:9 HD)
- **DRC**: 854x480 (GamePad 화면)
- **Logo**: 170x42

기능:
- 종횡비 보존 옵션
- RGBA 지원 PNG 출력
- Pillow 기반 리사이징 (LANCZOS 알고리즘)
- 이미지 유효성 검증

### D. 리소스 관리 레이어

**`resources.py` - `ResourceManager` 클래스**
- 다중 경로 리소스 탐색 (소스/설치됨/PyInstaller)
- TOOLDIR.zip을 임시 디렉터리로 추출
- 임베디드 리소스 처리 (wiitdb.txt)
- 크로스 플랫폼 리소스 경로 해결

**`paths.py` - `PathManager` 클래스**
- 중앙집중식 경로 관리 싱글톤
- 플랫폼별 경로:
  - **Windows**: `%TEMP%/WiiVCInjector/`, `%PROGRAMDATA%/JNUSToolDownloads/`
  - **Unix**: `/tmp/WiiVCInjector/`, `~/.JNUSToolDownloads/`
- 자동 임시 디렉터리 생성/정리
- 도구 실행 파일 경로 해결 (Windows에서 .exe)

### E. 유틸리티 레이어

**`utils.py` - 유틸리티 함수**
- `run_process()`: 윈도우 숨김 기능을 가진 외부 도구 실행기
- `check_internet_connection()`: 네트워크 유효성 검사
- `get_short_path_name()`: Windows 8.3 경로 변환 (도구용)
- 바이트/16진수 변환 헬퍼

**`string_util.py` - 문자열 처리**
- 유니코드 발음 기호 제거 (NFD 정규화)
- ASCII 정리
- 인덱스 위치 문자 교체

### F. 다이얼로그 레이어

**`settings_dialog.py` - `SettingsDialog` 클래스**
- JSON 기반 설정 저장 (~/.wiivc_injector_settings.json)
- 배너 리포지터리 URL 설정
- 출력 디렉터리 선택

**`sdcard_dialog.py` - `SDCardDialog` 클래스**
- Windows 드라이브 감지 (kernel32.dll 사용)
- Nintendont 설정 옵션
- 메모리 카드 설정 (251/507/1019/2043 블록)
- 비디오 모드 선택 (PAL50/PAL60/NTSC/MPAL)

---

## 4. Wii VC 인젝션 프로세스 상세

### Phase 1: 베이스 파일 획득

Nintendo CDN에서 다운로드:
```
- Title ID 0005001010004000 (Wii U 시스템 파일)
  - deint.txt (디인터레이싱 설정)
  - font.bin (시스템 폰트)

- Title ID 0005001010004001 (C2W 패처 파일)
  - c2w.img (Cafe2Wii 이미지)
  - boot.bin, dmcu.d.hex

- Title ID 00050000101b0700 (Rhythm Heaven Fever 베이스)
  - frisbiiU.rpx (메인 실행 파일)
  - fw.img, fw.tmd (펌웨어)
  - htk.bin, nn_hai_user.rpl (라이브러리)
  - bootMovie.h264, bootSound.btsnd
  - shaders (banner.gsh, fade.gsh)
```

MD5 검증으로 파일 무결성 확인 후 사용.

### Phase 2: ISO 헤더 파싱

**Wii ISO 구조:**
```
오프셋 0x00-0x05: Game ID (예: "RMCE01")
오프셋 0x18-0x1F: GameType 마커
                   - 2745048157 = Wii
                   - 4440324665927270400 = GameCube
오프셋 0x20-0x5F: 내부 게임명 (null-terminated ASCII)
```

**특수 포맷 감지:**
- **WBFS**: 0x00-0x03 == "WBFS"이면 오프셋 0x200에서 읽기
- **NKIT**: 0x200-0x203 == "NKIT"이면 unscrubbing 필요
- **NASOS**:
  - 0x00-0x03 == "WII5" → 오프셋 0x1182800
  - 0x00-0x03 == "WII9" → 오프셋 0x1FB5000

### Phase 3: 시스템별 처리

#### Wii 정품 게임:
```
1. WBFS → ISO 변환 (필요시)
2. wit.exe로 ISO 추출:
   wit extract "game.iso" --DEST temp/ --psel data,-update
3. 패치 적용:
   - Classic Controller 강제 (GetExtTypePatcher.exe)
   - 비디오 모드 변경 (wii-vmc.exe)
4. ISO 재구성:
   wit copy temp/ --DEST game.iso --iso --wiimmfi
5. TMD/TIK 추출:
   wit extract --files +tmd.bin --files +ticket.bin
```

#### GameCube 정품 게임:
```
1. Nintendont 로더로 래핑:
   - BASE/ 디렉터리 복사
   - main.dol 변종 선택:
     - nintendont_default_autobooter.dol
     - nintendont_force_4_by_3_autobooter.dol
     - nintendont_force_interlaced_autobooter.dol
     - nintendont_forwarder.dol (자동 부팅 없음)
2. game.iso를 files/game.iso로 복사
3. 2개 디스크 게임인 경우: disc2.iso 복사
4. wit로 래퍼 ISO 빌드
```

#### Wii 홈브류 (DOL):
```
1. BASE/ 디렉터리 복사
2. boot.dol → sys/main.dol로 복사
3. 래퍼 ISO 빌드
```

#### Wii NAND 채널:
```
1. 사용자가 4글자 Title ID 제공 (예: "NADE")
2. FIX94의 wiivc_chan_booter.dol 사용
3. Title ID를 files/title.txt에 작성
4. 래퍼 ISO 빌드
```

### Phase 4: 에셋 변환

**이미지 파이프라인:**
```
사용자 PNG → 리사이징 (Pillow) → PNG (임시) → TGA (png2tgacmd)

사양:
- iconTex.tga: 128x128, 32bpp, 압축 없음
- bootTvTex.tga: 1280x720, 24bpp, 압축 없음
- bootDrcTex.tga: 854x480, 24bpp, 압축 없음
- bootLogoTex.tga: 170x42, 32bpp, 압축 없음
```

**오디오 파이프라인:**
```
사용자 WAV/MP3 → sox (48kHz, 16-bit, 스테레오, 최대 6초로 변환)
                → wav2btsnd (BTSND 포맷으로 변환, 선택적 루프)
```

### Phase 5: 메타데이터 생성

**app.xml (애플리케이션 디스크립터):**
```xml
<title_id>00050002[GameIDHex]</title_id>
<group_id>[GameIDHex]</group_id>
<os_version>000500101000400A</os_version>
```

**meta.xml (메뉴 메타데이터):**
```xml
<drc_use>1 (Wii) | 65537 (GC/홈브류)</drc_use>
<longname_*>게임 제목 (모든 언어)</longname_*>
<shortname_*>게임 제목</shortname_*>
<product_code>WUP-N-[TitleIDText]</product_code>
```

### Phase 6: NFS 파일시스템 변환

**nfs2iso2nfs.exe 파라미터:**
```
Wii:  -enc [-nfspatch] [-lrpatch] [-wiimmfi] -iso "game.iso"
GC:   -enc -homebrew -passthrough -iso "game.iso"
DOL:  -enc -homebrew [-passthrough] -iso "game.iso"

결과: NFS 파일시스템을 가진 content/ 디렉터리 생성
```

### Phase 7: WUP 패키지 생성

**NUSPacker:**
```
입력: BUILDDIR/ (code/, content/, meta/)
출력: WUP-N-[TitleID]_[TitleIDHex]/

암호화:
- Wii U Common Key (타이틀 암호화용)
- Title Key (컨텐츠 복호화용)
- Ancast Key (선택사항, C2W 패칭용)
```

---

## 5. 파일 타입 처리 및 변환 파이프라인

### 지원되는 입력 포맷

**게임 이미지:**
- `.iso` - 표준 Wii/GC ISO 덤프
- `.wbfs` - WBFS 압축 포맷 (변환 필요)
- `.nkit.iso` - NKit scrubbed 포맷 (unscrubbing 필요)
- `.iso.dec` - NASOS 포맷 (다른 헤더 오프셋)
- `.gcm` - GameCube Master Disc 포맷
- `.dol` - Wii/GC 실행 파일 (홈브류)

**이미지 에셋:**
- `.png`, `.jpg`, `.jpeg`, `.bmp` (PNG → TGA로 자동 변환)
- `.tga` (직접 사용, 미리보기용으로 PNG로 변환)

**오디오 에셋:**
- `.wav`, `.mp3` (48kHz 16-bit 스테레오 BTSND로 변환)

### 변환 파이프라인 전체 흐름

```
입력 게임 파일 → 포맷 감지 → 전처리
                              ↓
              ┌───────────────┴──────────────┐
              │                              │
           WBFS?                          NKIT?
              │                              │
        wbfs_file.exe                ConvertToISO.exe
              │                              │
              └───────────┬──────────────────┘
                          ↓
                  표준 ISO 포맷
                          ↓
              ┌───────────┴───────────┐
              │                       │
           Wii ISO                 GC ISO
              │                       │
      ┌───────┴────────┐          Nintendont
      │                │           래퍼
   추출           NASOS?              │
      │                │               │
   DOL 패치     오프셋 이동            │
      │                │               │
   ISO 재구성          │               │
      │                │               │
      └────────┬───────┘               │
               └───────────┬───────────┘
                           ↓
                   TMD/TIK 추출
                           ↓
                   NFS 변환 (nfs2iso2nfs)
                           ↓
                   ┌───────┴────────┐
                   │                │
              code/ + content/   meta/
                   │                │
                   └────────┬───────┘
                            ↓
                   NUSPacker 암호화
                            ↓
                   WUP 설치 가능 패키지
```

### 이미지 처리 파이프라인

```
사용자 이미지 → 유효성 검사 → 리사이징 (Pillow LANCZOS)
                                  ↓
                        종횡비 결정
                                  ↓
                ┌─────────────────┴─────────────────┐
                │                                   │
          종횡비 유지                          늘려서 채우기
                │                                   │
      맞춤 + 중앙 붙여넣기                    직접 리사이징
                │                                   │
                └─────────────┬─────────────────────┘
                              ↓
                      PNG로 저장 (임시)
                              ↓
                  png2tgacmd.exe (포맷 변환)
                              ↓
                  TGA (특정 bpp, 압축 없음)
                              ↓
              빌드의 meta/ 디렉터리로 복사
```

---

## 6. 아키텍처 패턴

### 디자인 패턴

#### 1. **싱글톤 패턴 (Singleton Pattern)**
- `PathManager` (paths.py): 단일 전역 인스턴스 `paths`
- `ResourceManager` (resources.py): 단일 전역 인스턴스 `resources`
- `GameTdb` (game_tdb.py): 지연 로딩 캐시 싱글톤
- `ImageProcessor`, `GameInfoExtractor`: 모듈 레벨 싱글톤 인스턴스

#### 2. **파사드 패턴 (Facade Pattern)**
- `GameInfoExtractor`: 복잡한 바이너리 파싱을 간단한 인터페이스로 숨김
- `ImageProcessor`: 특정 이미지 작업을 위한 Pillow 복잡성 추상화
- `ResourceManager`: 플랫폼 간 리소스 접근을 위한 통합 인터페이스

#### 3. **전략 패턴 (Strategy Pattern)**
- 시스템 타입 선택 (Wii/GC/DOL/NAND)이 서로 다른 처리 전략 결정
- 각 시스템 타입마다 C# 원본에서 구별되는 빌드 파이프라인
- Python 버전은 RadioButton 상태를 통해 구조화

#### 4. **템플릿 메서드 패턴 (Template Method Pattern)**
- C#의 빌드 프로세스는 고정된 템플릿을 따름:
  1. 베이스 다운로드
  2. 게임 처리
  3. 에셋 처리
  4. 메타데이터 생성
  5. NFS로 변환
  6. 패키징
- 각 단계는 시스템 타입에 따라 오버라이드 가능

#### 5. **MVC 패턴 (Model-View-Controller)**
- **View**: PyQt5 UI 컴포넌트 (main_window.py, dialogs)
- **Model**: 데이터 클래스 (game_info, JSON으로서의 설정)
- **Controller**: WiiVCInjectorWindow의 이벤트 핸들러

#### 6. **팩토리 패턴 (Factory Pattern)**
- `run_process()` in utils.py: 플랫폼별 플래그로 ProcessStartInfo 생성
- `get_tool_path()` in paths.py: 플랫폼별 실행 파일 경로 반환

#### 7. **지연 로딩 패턴 (Lazy Loading Pattern)**
- `GameTdb._load_database()`: 첫 액세스 시에만 데이터베이스 로드
- `ResourceManager._get_resources_dir()`: 필요할 때 리소스 탐색

#### 8. **데코레이터 패턴 (Decorator Pattern)**
- `run_process()`: 윈도우 숨김, 에러 처리로 서브프로세스 래핑
- 짧은 경로명 변환이 도구 호환성을 위한 경로를 장식

### 아키텍처 스타일

#### **이벤트 기반 아키텍처 (Event-Driven Architecture):**
- Qt signals/slots에 의해 구동되는 GUI
- 사용자 액션이 이벤트 핸들러 트리거
- 비동기 작업 (파일 다이얼로그, 프로세스 실행)

#### **계층형 아키텍처 (Layered Architecture):**
```
┌─────────────────────────────────────┐
│   프레젠테이션 계층 (PyQt5 UI)     │
├─────────────────────────────────────┤
│   애플리케이션 계층 (Controllers)  │
├─────────────────────────────────────┤
│   비즈니스 로직 계층                │
│   (게임 처리, 에셋 핸들링)          │
├─────────────────────────────────────┤
│   데이터 접근 계층                  │
│   (파일 I/O, 바이너리 파싱)        │
├─────────────────────────────────────┤
│   인프라 계층                       │
│   (외부 도구, OS 인터페이스)       │
└─────────────────────────────────────┘
```

#### **파이프라인 아키텍처 (Pipeline Architecture):**
- 빌드 프로세스는 데이터 변환 파이프라인
- 각 단계는 이전 단계의 출력을 소비
- 상태 없는 변환 (함수형 스타일)

#### **임시 작업공간 패턴 (Temporary Workspace Pattern):**
- 모든 작업은 임시 디렉터리에서 수행
- 종료 시 정리 (Python의 컨텍스트 매니저 스타일)
- 사용자 파일시스템으로부터 격리

#### **크로스 플랫폼 추상화 (Cross-Platform Abstraction):**
플랫폼별 코드가 다음에 격리됨:
- `PathManager` (임시 경로, JNUSTool 위치)
- `utils.get_short_path_name()` (Windows 전용)
- `SDCardDialog.reload_drives()` (Windows 드라이브 감지)

---

## 7. 구현 현황 요약

### 완료된 컴포넌트 (100%)
✅ **GUI 레이어**: PyQt5 포트 완료
✅ **데이터 추출**: ISO 파싱, 게임 데이터베이스
✅ **에셋 처리**: 이미지 리사이징, 유효성 검사
✅ **경로 관리**: 크로스 플랫폼 지원
✅ **설정 저장**: JSON 기반

### 미구현 핵심 컴포넌트 (빌드 로직)
❌ 외부 도구 통합 (wit, nfs2iso2nfs, NUSPacker 실행)
❌ JNUSTool 다운로드 워크플로우
❌ ISO 추출/재구성 파이프라인
❌ NFS 변환 프로세스
❌ 메타데이터 XML 생성 (app.xml, meta.xml)
❌ WUP 패키징 및 암호화
❌ 패치 적용 (C2W, Wiimmfi, LR patch)
❌ 오디오 변환 파이프라인 (WAV → BTSND)
❌ TGA 변환 파이프라인 (PNG → TGA via png2tgacmd)

### 개선 사항

Python 재작성은 C# 원본과 아키텍처적 동등성을 유지하면서 다음을 개선:

✨ **크로스 플랫폼 호환성**: Windows/Linux/macOS 지원
✨ **코드 조직**: 모듈형 디자인
✨ **종속성 관리**: requirements.txt
✨ **빌드 시스템**: PyInstaller

핵심 인젝션 워크플로우 로직은 TeconMoon의 원본 디자인을 충실히 따르며, 앞으로 해야 할 주요 작업은 외부 도구 통합과 다단계 빌드 파이프라인 구현입니다.

---

## 참고 사항

이 문서는 TeconmoonWiiVCInjector의 **기술적 구조와 아키텍처**에 초점을 맞춘 분석입니다.

- **변환 프로세스**: Wii/GameCube 게임을 Wii U Virtual Console 포맷으로 변환
- **핵심 기술**: ISO 파일 조작, NFS 파일시스템, 암호화, 메타데이터 생성
- **외부 도구 의존성**: 여러 특수 도구들이 협력하여 완전한 변환 수행

---

*문서 생성 일자: 2025-11-07*
*분석 대상: TeconmoonWiiVCInjector Python 버전*
